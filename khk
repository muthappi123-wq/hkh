import streamlit as st
import requests
from datetime import datetime
import json

# Configuration
API_BASE_URL = "http://localhost:8000"
BLOB_BASE_URL = "https://yourstorageaccount.blob.core.windows.net/yourcontainer"

# Page config
st.set_page_config(
    page_title="AI Assistant - Multi-Index Retriever",
    page_icon="ü§ñ",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Custom CSS
st.markdown("""
    <style>
    .main {
        background: linear-gradient(to bottom right, #EFF6FF, #E0E7FF);
    }
    .stChatMessage {
        background-color: white;
        border-radius: 10px;
        padding: 10px;
        margin: 10px 0;
    }
    .citation-box {
        background-color: #DBEAFE;
        padding: 10px;
        border-radius: 8px;
        margin: 5px 0;
        border-left: 4px solid #3B82F6;
    }
    .link-box {
        background-color: #D1FAE5;
        padding: 10px;
        border-radius: 8px;
        margin: 5px 0;
        border-left: 4px solid #10B981;
    }
    .exception-box {
        background-color: #FED7AA;
        padding: 10px;
        border-radius: 8px;
        margin: 5px 0;
        border-left: 4px solid #F97316;
    }
    .metric-box {
        background-color: #F3F4F6;
        padding: 15px;
        border-radius: 10px;
        margin: 10px 0;
    }
    </style>
""", unsafe_allow_html=True)

# Initialize session state
if "messages" not in st.session_state:
    st.session_state.messages = []

if "user_context" not in st.session_state:
    st.session_state.user_context = {
        "userId": "user_001",
        "userName": "John Doe",
        "userLocation": "United States",
        "deviceType": "web",
        "sessionId": f"session_{datetime.now().timestamp()}",
        "bearerToken": "",
        "scopeIndex": 0,
        "userCategory": "general"
    }

# Sidebar - User Context Settings
with st.sidebar:
    st.title("‚öôÔ∏è Settings")
    st.markdown("---")
    
    st.subheader("User Context")
    
    st.session_state.user_context["userId"] = st.text_input(
        "User ID",
        value=st.session_state.user_context["userId"]
    )
    
    st.session_state.user_context["userName"] = st.text_input(
        "User Name",
        value=st.session_state.user_context["userName"]
    )
    
    st.session_state.user_context["userLocation"] = st.text_input(
        "Country/Location üåç",
        value=st.session_state.user_context["userLocation"],
        help="This will be used as the country filter for searches"
    )
    
    st.session_state.user_context["userCategory"] = st.selectbox(
        "User Category",
        ["general", "premium", "enterprise"],
        index=0
    )
    
    st.markdown("---")
    
    # Display current session info
    st.subheader("üìä Session Info")
    st.info(f"**Session ID:**\n{st.session_state.user_context['sessionId']}")
    st.success(f"**Filtering by:**\n{st.session_state.user_context['userLocation']}")
    
    st.markdown("---")
    
    # Clear chat button
    if st.button("üóëÔ∏è Clear Chat History", use_container_width=True):
        st.session_state.messages = []
        st.rerun()
    
    # API Health Check
    st.markdown("---")
    st.subheader("üîå API Status")
    try:
        response = requests.get(f"{API_BASE_URL}/health", timeout=2)
        if response.status_code == 200:
            st.success("‚úÖ Connected")
        else:
            st.error("‚ùå API Error")
    except:
        st.error("‚ùå Disconnected")

# Main content
st.title("ü§ñ AI Assistant")
st.markdown("*Multi-Index Retriever - Ask me anything!*")
st.markdown("---")

# Display chat messages
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])
        
        # Display metadata if available
        if "metadata" in message and message["metadata"]:
            metadata = message["metadata"]
            
            # Exception Flag
            if metadata.get("exceptionFlag"):
                st.markdown("### ‚ö†Ô∏è Exception Response")
            
            # Confidence Score & Topic
            if metadata.get("confidenceScore", 0) > 0:
                col1, col2 = st.columns(2)
                with col1:
                    st.metric("Confidence Score", f"{metadata['confidenceScore']}%")
                with col2:
                    if metadata.get("topic"):
                        st.metric("Topic", metadata["topic"])
            
            # Document Citations
            if metadata.get("documentCitations"):
                st.markdown("### üìÑ Document Citations")
                for i, citation in enumerate(metadata["documentCitations"]):
                    with st.expander(f"üìë {citation['displayText']}", expanded=False):
                        blob_url = get_blob_url(citation['url'])
                        st.markdown(f"**Blob URL:**")
                        st.code(blob_url, language=None)
                        st.link_button("üîó Open Document", blob_url, use_container_width=True)
            
            # Application Links
            if metadata.get("links"):
                st.markdown("### üîó Related Links")
                for link in metadata["links"]:
                    st.markdown(
                        f'<div class="link-box">üîó <a href="{link["url"]}" target="_blank">{link["displayText"]}</a></div>',
                        unsafe_allow_html=True
                    )
            
            # Exception Links
            if metadata.get("exceptionLinks"):
                st.markdown("### ‚ö†Ô∏è Exception Resources")
                for link in metadata["exceptionLinks"]:
                    st.markdown(
                        f'<div class="exception-box">‚ö†Ô∏è <a href="{link["url"]}" target="_blank">{link["displayText"]}</a></div>',
                        unsafe_allow_html=True
                    )
            
            # Suggested Questions
            if metadata.get("suggestedQuestions"):
                st.markdown("### üí° You might also ask:")
                for question in metadata["suggestedQuestions"]:
                    if st.button(f"‚ùì {question}", key=f"suggest_{hash(question)}"):
                        # This will trigger a rerun with the suggested question
                        st.session_state.suggested_query = question
                        st.rerun()

# Helper function to construct blob URL
def get_blob_url(blob_filepath):
    if not blob_filepath:
        return "#"
    if blob_filepath.startswith("http"):
        return blob_filepath
    return f"{BLOB_BASE_URL}/{blob_filepath}"

# Chat input
if prompt := st.chat_input("Ask me anything..."):
    # Check if this is from a suggested question
    if hasattr(st.session_state, 'suggested_query'):
        prompt = st.session_state.suggested_query
        delattr(st.session_state, 'suggested_query')
    
    # Add user message to chat
    st.session_state.messages.append({"role": "user", "content": prompt})
    
    # Display user message
    with st.chat_message("user"):
        st.markdown(prompt)
    
    # Display assistant response with spinner
    with st.chat_message("assistant"):
        with st.spinner("Thinking..."):
            try:
                # Make API request
                response = requests.post(
                    f"{API_BASE_URL}/query",
                    json={
                        "textInput": prompt,
                        "userContext": st.session_state.user_context
                    },
                    timeout=30
                )
                
                if response.status_code == 200:
                    data = response.json()
                    
                    # Display response text
                    st.markdown(data["responseText"])
                    
                    # Prepare metadata
                    metadata = {
                        "exceptionFlag": data.get("exceptionFlag", False),
                        "confidenceScore": data.get("confidenceScore", 0),
                        "topic": data.get("topic", ""),
                        "documentCitations": data.get("documentCitations", []),
                        "links": data.get("links", []),
                        "exceptionLinks": data.get("exceptionLinks", []),
                        "suggestedQuestions": data.get("suggestedQuestions", [])
                    }
                    
                    # Display metadata immediately
                    if metadata["exceptionFlag"]:
                        st.markdown("### ‚ö†Ô∏è Exception Response")
                    
                    if metadata["confidenceScore"] > 0:
                        col1, col2 = st.columns(2)
                        with col1:
                            st.metric("Confidence Score", f"{metadata['confidenceScore']}%")
                        with col2:
                            if metadata["topic"]:
                                st.metric("Topic", metadata["topic"])
                    
                    # Document Citations
                    if metadata["documentCitations"]:
                        st.markdown("### üìÑ Document Citations")
                        for citation in metadata["documentCitations"]:
                            with st.expander(f"üìë {citation['displayText']}", expanded=False):
                                blob_url = get_blob_url(citation['url'])
                                st.markdown(f"**Blob URL:**")
                                st.code(blob_url, language=None)
                                st.link_button("üîó Open Document", blob_url, use_container_width=True)
                    
                    # Application Links
                    if metadata["links"]:
                        st.markdown("### üîó Related Links")
                        for link in metadata["links"]:
                            st.markdown(
                                f'<div class="link-box">üîó <a href="{link["url"]}" target="_blank">{link["displayText"]}</a></div>',
                                unsafe_allow_html=True
                            )
                    
                    # Exception Links
                    if metadata["exceptionLinks"]:
                        st.markdown("### ‚ö†Ô∏è Exception Resources")
                        for link in metadata["exceptionLinks"]:
                            st.markdown(
                                f'<div class="exception-box">‚ö†Ô∏è <a href="{link["url"]}" target="_blank">{link["displayText"]}</a></div>',
                                unsafe_allow_html=True
                            )
                    
                    # Suggested Questions
                    if metadata["suggestedQuestions"]:
                        st.markdown("### üí° You might also ask:")
                        for question in metadata["suggestedQuestions"]:
                            if st.button(f"‚ùì {question}", key=f"suggest_{hash(question)}_{len(st.session_state.messages)}"):
                                st.session_state.suggested_query = question
                                st.rerun()
                    
                    # Add assistant message to chat history
                    st.session_state.messages.append({
                        "role": "assistant",
                        "content": data["responseText"],
                        "metadata": metadata
                    })
                
                else:
                    error_msg = f"Error: API returned status code {response.status_code}"
                    st.error(error_msg)
                    st.session_state.messages.append({
                        "role": "assistant",
                        "content": error_msg
                    })
            
            except requests.exceptions.Timeout:
                error_msg = "Error: Request timed out. Please try again."
                st.error(error_msg)
                st.session_state.messages.append({
                    "role": "assistant",
                    "content": error_msg
                })
            
            except requests.exceptions.ConnectionError:
                error_msg = "Error: Could not connect to API. Make sure the backend is running on http://localhost:8000"
                st.error(error_msg)
                st.session_state.messages.append({
                    "role": "assistant",
                    "content": error_msg
                })
            
            except Exception as e:
                error_msg = f"Error: {str(e)}"
                st.error(error_msg)
                st.session_state.messages.append({
                    "role": "assistant",
                    "content": error_msg
                })

# Footer
st.markdown("---")
st.markdown(
    "<div style='text-align: center; color: gray; font-size: 12px;'>"
    "Multi-Index Retriever API ‚Ä¢ Powered by Azure Cognitive Search & OpenAI"
    "</div>",
    unsafe_allow_html=True
)
